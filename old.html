<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Racing Programme</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc; 
            -webkit-user-select: none; 
            -moz-user-select: none; 
            -ms-user-select: none; 
            user-select: none; 
        }

        .vvip-gradient { background: linear-gradient(135deg, #f0f4f0 0%, #fffbeb 100%); }
        .table-input { border: none; width: 100%; background: transparent; font-weight: 600; color: #1e293b; outline: none; }
        .drag-handle { cursor: grab; color: #94a3b8; padding: 10px; }
        .drag-handle:active { cursor: grabbing; }
        .row-ghost { background-color: #fefce8 !important; opacity: 0.5; }
        
        .check-p { accent-color: #16a34a; }
        .check-np { accent-color: #dc2626; }
        
        .btn-premium {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .btn-premium:hover { transform: translateY(-1px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }

        .bw-mode { background: white !important; }
        .bw-mode .vvip-gradient { background: white !important; }
        .bw-mode input { color: black !important; }
        
        .upload-btn { display: none; }

        footer { 
            margin-top: 2rem; 
            padding: 1.5rem; 
            text-align: center; 
            color: #64748b; 
            font-size: 0.9rem; 
            font-weight: 800; 
            border-top: 1px solid #e2e8f0;
        }
    </style>
</head>
<body class="vvip-gradient min-h-screen p-4 md:p-8" oncontextmenu="return false;">

    <div id="capture-area" class="max-w-7xl mx-auto bg-white shadow-2xl rounded-2xl overflow-hidden border border-gray-200">
        <div id="header-section" class="bg-white px-8 py-6 border-b-2 border-green-100 flex flex-col md:flex-row justify-between items-center gap-6">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-green-600 rounded-full flex items-center justify-center text-white font-bold text-xl">LS</div>
                <h1 id="main-title" class="text-3xl font-black italic tracking-tighter text-gray-800 uppercase">Daily Racing Programme</h1>
            </div>
            
            <div class="flex flex-wrap gap-3">
                <input type="text" id="progDate" value="14/01/2026" class="border-2 border-yellow-200 rounded-lg p-2 font-bold w-40 text-center focus:border-green-500 transition-colors bg-yellow-50">
                <button onclick="generatePDF()" class="btn-premium bg-green-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-green-700 uppercase text-sm">PDF Output</button>
                <button onclick="generatePDFBW()" class="btn-premium bg-gray-800 text-white px-6 py-2 rounded-lg font-bold hover:bg-black uppercase text-sm">Print 2 (B&W)</button>
                <button onclick="generatePNG()" class="btn-premium bg-yellow-500 text-white px-6 py-2 rounded-lg font-bold hover:bg-yellow-600 uppercase text-sm">PNG Image</button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2">
            <div class="border-r border-gray-100 table-container">
                <div class="bg-green-50 p-4 flex justify-between items-center border-b border-green-100 section-head">
                    <div class="flex flex-col gap-1">
                        <span class="font-black text-green-800 flex items-center gap-2">
                            <span class="w-2 h-2 bg-green-500 rounded-full status-dot"></span> HORSE MEETINGS
                        </span>
                        <label class="text-[10px] bg-white border border-green-200 px-2 py-0.5 rounded cursor-pointer hover:bg-green-100 font-bold text-green-700">
                            üìÅ UPLOAD PDF
                            <input type="file" class="upload-btn" accept=".pdf" onchange="handlePdfUpload(this, 'horseBody')">
                        </label>
                    </div>
                    <button onclick="addRow('horseBody')" class="bg-green-600 text-white text-xs px-3 py-1.5 rounded-md font-bold hover:bg-green-700 transition-all hide-on-export">+ ADD NEW</button>
                </div>
                <table class="w-full">
                    <thead class="bg-gray-50 text-[10px] uppercase text-gray-500 font-bold border-b border-gray-100">
                        <tr>
                            <th class="p-3 w-10"></th>
                            <th class="p-3 text-left">Meeting</th>
                            <th class="p-3 w-20 text-center">Printed</th>
                            <th class="p-3 w-20 text-center">Not Printed</th>
                            <th class="p-3 w-10"></th>
                        </tr>
                    </thead>
                    <tbody id="horseBody">
                    </tbody>
                </table>
            </div>

            <div class="table-container">
                <div class="bg-yellow-50 p-4 flex justify-between items-center border-b border-yellow-100 section-head">
                    <div class="flex flex-col gap-1">
                        <span class="font-black text-yellow-800 flex items-center gap-2">
                            <span class="w-2 h-2 bg-yellow-500 rounded-full status-dot"></span> GREYHOUND MEETINGS
                        </span>
                        <label class="text-[10px] bg-white border border-yellow-200 px-2 py-0.5 rounded cursor-pointer hover:bg-yellow-100 font-bold text-yellow-700">
                            üìÅ UPLOAD PDF
                            <input type="file" class="upload-btn" accept=".pdf" onchange="handlePdfUpload(this, 'greyBody')">
                        </label>
                    </div>
                    <button onclick="addRow('greyBody')" class="bg-yellow-600 text-white text-xs px-3 py-1.5 rounded-md font-bold hover:bg-yellow-700 transition-all hide-on-export">+ ADD NEW</button>
                </div>
                <table class="w-full">
                    <thead class="bg-gray-50 text-[10px] uppercase text-gray-500 font-bold border-b border-gray-100">
                        <tr>
                            <th class="p-3 w-10"></th>
                            <th class="p-3 text-left">Meeting</th>
                            <th class="p-3 w-20 text-center">Printed</th>
                            <th class="p-3 w-20 text-center">Not Printed</th>
                            <th class="p-3 w-10"></th>
                        </tr>
                    </thead>
                    <tbody id="greyBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <footer>
        ¬© 2026 | LS Publication Racing Dept. | Developed by Charith Neranga

    </footer>

    <script>
        // Security logic
        document.onkeydown = function(e) {
            if (e.keyCode == 123) return false;
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) return false;
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) return false;
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) return false;
            if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) return false;
            if (e.ctrlKey && e.keyCode == 'S'.charCodeAt(0)) return false;
        };

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        // Drag and Drop Initialization
        const horseSort = new Sortable(document.getElementById('horseBody'), { animation: 150, handle: '.drag-handle', ghostClass: 'row-ghost' });
        const greySort = new Sortable(document.getElementById('greyBody'), { animation: 150, handle: '.drag-handle', ghostClass: 'row-ghost' });

        // Add pre-filled meetings on page load
        window.onload = function() {
            addRow('horseBody', 'PORTMAN PARK (VR)');
            addRow('horseBody', 'SPRINT VALLEY (VR)');
            addRow('horseBody', 'STEEPLEDOWNS (VR)');
            addRow('greyBody', 'BRUSHWOOD (VR)');
            addRow('greyBody', 'MILLERSFIELD (VR)');
        };

        function addRow(id, value = "") {
            const body = document.getElementById(id);
            const tr = document.createElement('tr');
            tr.className = "border-b border-gray-50 group hover:bg-gray-50 transition-colors";
            tr.innerHTML = `
                <td class="p-3 text-center drag-handle">‚ãÆ‚ãÆ</td>
                <td class="p-3"><input type="text" class="table-input" placeholder="MEETING NAME" value="${value.toUpperCase()}"></td>
                <td class="p-3 text-center"><input type="checkbox" class="check-p w-4 h-4"></td>
                <td class="p-3 text-center"><input type="checkbox" class="check-np w-4 h-4"></td>
                <td class="p-3"><button onclick="this.parentElement.parentElement.remove()" class="text-gray-300 hover:text-red-500 transition-colors hide-on-export">‚úï</button></td>
            `;
            body.appendChild(tr);
        }

        async function handlePdfUpload(input, tableId) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async function() {
                const typedarray = new Uint8Array(this.result);
                const pdf = await pdfjsLib.getDocument(typedarray).promise;
                let meetingsFound = new Set();
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    const items = content.items;
                    for (let j = 0; j < items.length; j++) {
                        let str = items[j].str.trim();
                        if (tableId === 'horseBody') {
                            if (str.includes("Going:")) {
                                for (let k = j - 1; k >= 0; k--) {
                                    let prevStr = items[k].str.trim();
                                    if (prevStr.length > 2 && !prevStr.includes("PAGE") && isNaN(prevStr)) {
                                        meetingsFound.add(prevStr.toUpperCase());
                                        break;
                                    }
                                }
                            }
                        } else {
                            if (/^\([A-Z][a-z]\)$/.test(str)) { 
                                for (let k = j - 1; k >= 0; k--) {
                                    let prevStr = items[k].str.trim();
                                    if (prevStr.length > 2 && !prevStr.includes("PAGE") && /^[A-Z\s-]{3,}$/.test(prevStr)) {
                                        meetingsFound.add(prevStr.toUpperCase());
                                        break;
                                    }
                                }
                            }
                        }
                    }
                }
                meetingsFound.forEach(meeting => {
                    const cleanName = meeting.replace(/\(.*\)/, "").trim();
                    const existing = Array.from(document.querySelectorAll(`#${tableId} .table-input`)).some(input => input.value === cleanName);
                    if (!existing && cleanName.length > 2) addRow(tableId, cleanName);
                });
                input.value = ""; 
            };
            reader.readAsArrayBuffer(file);
        }

        async function generatePNG() {
            const element = document.getElementById('capture-area');
            const title = document.getElementById('main-title');
            element.classList.add('bw-mode');
            title.style.textDecoration = "underline";
            const hideItems = document.querySelectorAll('.hide-on-export, .drag-handle, button, label');
            hideItems.forEach(el => el.style.opacity = '0');
            const canvas = await html2canvas(element, { scale: 3, backgroundColor: '#ffffff' });
            const link = document.createElement('a');
            link.download = `Racing_Programme_${document.getElementById('progDate').value}.png`;
            link.href = canvas.toDataURL("image/png");
            link.click();
            element.classList.remove('bw-mode');
            title.style.textDecoration = "none";
            hideItems.forEach(el => el.style.opacity = '1');
        }

        function getTableData(tbodyId) {
            let total = 0, p = 0, np = 0;
            const rows = Array.from(document.querySelectorAll(`#${tbodyId} tr`)).map((tr, index) => {
                const inputs = tr.querySelectorAll('input');
                if(inputs[0].value.trim() !== "") total++;
                if(inputs[1].checked) p++;
                if(inputs[2].checked) np++;
                return [`(${index + 1})`, inputs[0].value.toUpperCase(), {content: "", drawMark: inputs[1].checked, markType: 'check'}, {content: "", drawMark: inputs[2].checked, markType: 'x'}];
            });
            return { rows, total, p, np };
        }

        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            const progDate = document.getElementById('progDate').value;
            doc.setFont("helvetica", "bold");
            doc.setFontSize(22);
            doc.text("DAILY RACING PROGRAMME", 148, 15, { align: "center" });
            const tw = doc.getTextWidth("DAILY RACING PROGRAMME");
            doc.line(148 - (tw/2), 17, 148 + (tw/2), 17);
            const horse = getTableData('horseBody');
            const grey = getTableData('greyBody');
            const max = Math.max(horse.rows.length, grey.rows.length);
            const finalBody = [];
            for(let i=0; i<max; i++) {
                const h = horse.rows[i] || ["", "", {content:""}, {content:""}];
                const g = grey.rows[i] || ["", "", {content:""}, {content:""}];
                finalBody.push([i===0 ? progDate : "", h[0], h[1], h[2], h[3], g[0], g[1], g[2], g[3]]);
            }
            finalBody.push([{content: 'TOTAL', styles: {fontStyle: 'bold', fillColor: [240, 240, 240]}},{content: horse.total.toString(), styles: {fontStyle: 'bold', halign: 'center'}},'',{content: horse.p.toString(), styles: {fontStyle: 'bold', halign: 'center'}},{content: horse.np.toString(), styles: {fontStyle: 'bold', halign: 'center'}},{content: grey.total.toString(), styles: {fontStyle: 'bold', halign: 'center'}},'',{content: grey.p.toString(), styles: {fontStyle: 'bold', halign: 'center'}},{content: grey.np.toString(), styles: {fontStyle: 'bold', halign: 'center'}}]);
            doc.autoTable({
                startY: 25,
                head: [['DATE', '', 'HORSE MEETINGS', 'PRINTED', 'NOT PRINTED', '', 'GREYHOUND MEETINGS', 'PRINTED', 'NOT PRINTED']],
                body: finalBody,
                theme: 'grid',
                styles: { font: "helvetica", lineColor: [0, 0, 0], lineWidth: 0.25, textColor: [0, 0, 0], fontSize: 9 },
                headStyles: { fillColor: [240, 250, 240], fontStyle: 'bold', halign: 'center' },
                columnStyles: { 0: {cellWidth: 25}, 1: {cellWidth: 10, halign: 'center'}, 2: {cellWidth: 70}, 3: {cellWidth: 20}, 4: {cellWidth: 20}, 5: {cellWidth: 10, halign: 'center'}, 6: {cellWidth: 70}, 7: {cellWidth: 20}, 8: {cellWidth: 20} },
                didDrawCell: function(data) {
                    const raw = data.cell.raw;
                    if (raw && raw.drawMark === true) {
                        const midX = data.cell.x + data.cell.width / 2;
                        const midY = data.cell.y + data.cell.height / 2;
                        doc.setLineWidth(0.6);
                        if (raw.markType === 'check') {
                            doc.setDrawColor(22, 163, 74);
                            doc.line(midX - 2, midY, midX - 0.5, midY + 2);
                            doc.line(midX - 0.5, midY + 2, midX + 2.5, midY - 2.5);
                        } else if (raw.markType === 'x') {
                            doc.setDrawColor(220, 38, 38);
                            doc.line(midX - 2, midY - 2, midX + 2, midY + 2);
                            doc.line(midX + 2, midY - 2, midX - 2, midY + 2);
                        }
                    }
                }
            });
            doc.save(`Daily_Programme_${progDate.replace(/\//g, '-')}.pdf`);
        }

        function generatePDFBW() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            const progDate = document.getElementById('progDate').value;
            doc.setFont("helvetica", "bold");
            doc.setFontSize(22);
            doc.text("DAILY RACING PROGRAMME", 148, 15, { align: "center" });
            const tw = doc.getTextWidth("DAILY RACING PROGRAMME");
            doc.line(148 - (tw/2), 17, 148 + (tw/2), 17);
            const horse = getTableData('horseBody');
            const grey = getTableData('greyBody');
            const max = Math.max(horse.rows.length, grey.rows.length);
            const finalBody = [];
            for(let i=0; i<max; i++) {
                const h = horse.rows[i] || ["", "", {content:""}, {content:""}];
                const g = grey.rows[i] || ["", "", {content:""}, {content:""}];
                finalBody.push([i===0 ? progDate : "", h[0], h[1], h[2], h[3], g[0], g[1], g[2], g[3]]);
            }
            finalBody.push([{content: 'TOTAL', styles: {fontStyle: 'bold'}},{content: horse.total.toString(), styles: {fontStyle: 'bold', halign: 'center'}},'',{content: horse.p.toString(), styles: {fontStyle: 'bold', halign: 'center'}},{content: horse.np.toString(), styles: {fontStyle: 'bold', halign: 'center'}},{content: grey.total.toString(), styles: {fontStyle: 'bold', halign: 'center'}},'',{content: grey.p.toString(), styles: {fontStyle: 'bold', halign: 'center'}},{content: grey.np.toString(), styles: {fontStyle: 'bold', halign: 'center'}}]);
            doc.autoTable({
                startY: 25,
                head: [['DATE', '', 'HORSE MEETINGS', 'PRINTED', 'NOT PRINTED', '', 'GREYHOUND MEETINGS', 'PRINTED', 'NOT PRINTED']],
                body: finalBody,
                theme: 'grid',
                styles: { font: "helvetica", lineColor: [0, 0, 0], lineWidth: 0.25, textColor: [0, 0, 0], fontSize: 9 },
                headStyles: { fillColor: [255, 255, 255], fontStyle: 'bold', halign: 'center', textColor: [0, 0, 0] },
                columnStyles: { 0: {cellWidth: 25}, 1: {cellWidth: 10, halign: 'center'}, 2: {cellWidth: 70}, 3: {cellWidth: 20}, 4: {cellWidth: 20}, 5: {cellWidth: 10, halign: 'center'}, 6: {cellWidth: 70}, 7: {cellWidth: 20}, 8: {cellWidth: 20} },
                didDrawCell: function(data) {
                    const raw = data.cell.raw;
                    if (raw && raw.drawMark === true) {
                        const midX = data.cell.x + data.cell.width / 2;
                        const midY = data.cell.y + data.cell.height / 2;
                        doc.setLineWidth(0.8);
                        doc.setDrawColor(0, 0, 0);
                        if (raw.markType === 'check') {
                            doc.line(midX - 2, midY, midX - 0.5, midY + 2);
                            doc.line(midX - 0.5, midY + 2, midX + 2.5, midY - 2.5);
                        } else if (raw.markType === 'x') {
                            doc.line(midX - 2, midY - 2, midX + 2, midY + 2);
                            doc.line(midX + 2, midY - 2, midX - 2, midY + 2);
                        }
                    }
                }
            });
            doc.save(`Daily_Programme_BW_${progDate.replace(/\//g, '-')}.pdf`);
        }
    </script>
</body>
</html>

